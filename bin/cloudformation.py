#!/usr/bin/env python3

import os
import re

INFRA_DIR = os.path.join(os.path.dirname(__file__), "..", "infra")
output = "# N.B. This file is automatically generated\n\n"

with open(os.path.join(INFRA_DIR, "cloudformation.template.yml"), "r") as template_file:
    for template_line in template_file.readlines():
        m = re.match("^(.*){{{(.*)}}}", template_line)

        if not m:
            output += template_line
            continue

        prefix = m.group(1)
        import_file_path = m.group(2)

        with open(os.path.join(INFRA_DIR, import_file_path)) as import_file:
            for import_line in import_file.readlines():
                output += f"{prefix}{import_line}"

with open(os.path.join(INFRA_DIR, "cloudformation.yml"), "w") as file:
    file.write(output)
